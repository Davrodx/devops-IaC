trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'ARM-Manager'
  location: 'eastus'
  namePrefix: 'myapp'
  tenantId: 'ed4ea245-6155-4c12-a192-b87bc12e9cc5'
  objectId: '8cc342d9-1d50-4a28-abd9-25ef76d9d4d4'

stages:
- stage: DeployInfrastructure
  jobs:
  - job: Deploy
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Starting Bicep deployment to existing resource group 'CareerPortfolio'..."
          az deployment group create \
            --resource-group CareerPortfolio \
            --template-file infra/main.bicep \
            --parameters namePrefix=$(namePrefix) location=$(location) tenantId=$(tenantId) objectId=$(objectId)
          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "✅ Deployment succeeded."
          elif [ $exit_code -eq 1 ]; then
            echo "⚠️ Deployment may have succeeded, but Azure CLI returned a known parsing error."
          else
            echo "❌ Deployment failed with exit code $exit_code"
            exit $exit_code
          fi
      displayName: 'Deploy Bicep Infrastructure'
