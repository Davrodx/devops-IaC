trigger:
  none


variables:
  azureSubscription: 'ARM-Manager'
  resourceGroupName: 'CareerPortfolio'
  location: 'East US'
  namePrefix: 'demo'

stages:
  - stage: DeployInfra
    displayName: 'Deploy Infrastructure with Bicep'
    jobs:
      - job: BicepDeployment
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "üîê Getting tenantId..."
                tenantId=$(az account show --query tenantId -o tsv)
                echo "‚úÖ tenantId: $tenantId"

                echo "üîê Using objectId (manually set or secret): $objectId"

                echo "üöÄ Starting Bicep deployment..."
                az deployment group create \
                  --resource-group $(resourceGroupName) \
                  --template-file infra/main.bicep \
                  --parameters namePrefix=$(namePrefix) \
                               tenantId=$(az account show --query tenantId -o tsv) \
                               objectId='8cc342d9-1d50-4a28-abd9-25ef76d9d4d4'

  - stage: BuildAndDeployApp
    displayName: 'Build and Deploy Node.js App'
    dependsOn: DeployInfra
    jobs:
      - job: DeployApp
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Use Node.js 18'

          - script: |
              cd src/api
              npm install
              zip -r $(Build.ArtifactStagingDirectory)/app.zip .
            displayName: 'Install & Zip API App'

          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: 'webApp'
              appName: '$(namePrefix)-webapp'
              package: '$(Build.ArtifactStagingDirectory)/app.zip'
            displayName: 'Deploy to Azure Web App'
